---
title: "Camera trapping for wildlife research - chapter 5"
output: html_notebook
---

## Introduction
One challenge we face is in getting our data into a format in which we can use some other people's code for our analysis (or at least see how other people's code works and modify to suit our needs).  Here's I'm going to work through the case study in Chapter 5 of Camera Trapping for Wildlife Research and work as well with one of our own sample files to try and push ours into the same format as CTFWR.

To do so, I need the R scripts they provide on their book [dropbox folder](https://www.dropbox.com/sh/5w4y6u7uq2mc2i3/AADjdBCrN_7tAg-UHAbhf8sFa?dl=0).


Prep workspace, set working directory, etc
```{r}
rm(list = ls())
library(dplyr)
library(ggplot2)
library(readr)

```

Because .Rmd files can be a pain at working directories b/w code chunks, do the following:
```{r setup, include=FALSE, cache = FALSE}
require("knitr")
## setting working directory
# opts_knit$set(root.dir = "/Volumes/External Drive/Dropbox/R/NoCoWild/CamTrapAnalysis/Camera Trapping for Wildlife Research/Chapter 5")  #lab power mac

```
Set some directories; can toggle on and off as needed via commenting
## working through Chapter 5 case study
```{r}
# lab_power_mac_TEAM<-"/Volumes/External Drive/Dropbox/R/NoCoWild/CamTrapAnalysis/Camera Trapping for Wildlife Research/Chapter 5"
# lab_power_mac<-"/Volumes/External Drive/Dropbox/R/NoCoWild/CamTrapAnalysis"
laptop_TEAM<-"~/Dropbox/R/NoCoWild/CamTrapAnalysis/Camera Trapping for Wildlife Research/Chapter 5"
laptop_dir<-"~/Dropbox/R/NoCoWild/CamTrapAnalysis"
```

Begin by sourcing the TEAM R scripts
```{r}
setwd(laptop_dir)
source(paste0(laptop_TEAM,"/TEAM library 1.7.R"))
```
Now load their suggested packages (which include ggplot2 already loaded above)

```{r}
library(chron)
library(reshape)
library(vegan)
library(plotrix)
library(maptools)
```
## Now load their data file and our data file
```{r}
team<-read_csv(paste0(laptop_TEAM,"/teamexample.csv"))
ours<-read_csv(paste0(laptop_dir,"/sampledatasmall.csv-flattened.csv"))
```
So far so good. Now let's compare how these two data frames are structured.

```{r}
View(team)
View(ours)
```
The team dataset includes the following columns:

Sampling.Unit.Name = col_character(),  
  Latitude = col_double(),  
  Longitude = col_double(),  
  Project.Name = col_character(),  
  Sampling.Event = col_double(),  
  Photo.Date = col_date(format = ""),  
  Photo.Time = col_time(format = ""),  
  Genus = col_character(),  
  Species = col_character(),  
  Number.of.Animals = col_double(),  
  Camera.Start.Date.and.Time = col_datetime(format = ""),  
  Camera.End.Date.and.Time = col_datetime(format = "")  
  
Whereas our dataset includes the following:

classification_id = col_double(),  
  subject_ids = col_numeric,  
  user_name = col_character(),  
  workflow_version,  
  task_index,  
  task,  
  task_label,  
  value,  
  total_submissions,  
  submission_index,  
  choice,  
  choice.1,   
  number,   
  SnowDepth,  
  Young,  
  Antlers,   
  Precipitation,   
  a bunch of behavior columns,   
  user_name_1,   
  workflow_id,   
  workflow_version_1,  
  ForestType,  
  ForestName,   
  Image1,   
  Image2,  
  Image3,  
  Camera,  
  SDCard,   
  PhotoBatch,  
  Class_round  

A primary difference between datasets is that theirs includes the date/time information and ours does not.  We may have to add it back from the manifest file we sent to the zooniverse.

## Continue with their steps
Their next step is to add taxonomic attributes so that they can then sort by taxon.  We don't need to do this step on our data, but I'll do it on their so that I can see how their data file is being changed with each step.

```{r}
iucn.full<-read.csv(paste0(laptop_TEAM,"/IUCN.csv"), sep = ",", h = T)

iucn<-iucn.full[,c("Class", "Order", "Family", "Genus", "Species")]

team<-merge(iucn, team, all.y = T)
#added 5 taxonomic columns to the data set
```

Now run their home made function called "fix.dta".  This function appears to change the date/time formats for those rows with that information and also splits out camera start date and camera end date. Will need to get back to this later with our data. The resulting df "data" of theirs is now the working dataset, rather than "team".

```{r}
data<-fix.dta(team)
```

###Checking data
Now we run through their steps for evaluating the data to check for issues

First, look at the column names
```{r}
names(data)
```
Next, extract data from a single year of the dataset, also extract mammals only
```{r}
yr2009<-data[data$Sampling.Event == "2009.01" & data$Class =="MAMMALIA",]
```
Now, other than the temporal data, we have something more similar to our dataset, since ours has been filtered by workflow ID and workflow version.  Similar to their step of isolating to a particular year of data.

Now lets see what species are in the data set and then remove the species we are not interested in, humans.

```{r}
# unique(yr2009$bin)
# data<-droplevels(yr2009[data$bin != "Homo sapiens",] ) 
```
This is their line of code, but it doesn't appear to be working.  Prior to this line, "data" has 76051 observations, but yr2009 has only 10623.  So since we are dropping data from yr2009, the result should be less than 10623 observations.  

I'll try it differently with dplyr Here's the dplyr version.
```{r}
data<-filter(yr2009, bin != "Homo sapiens")#this seems to have worked.
```
Next, check the number of camera trap stations in the database.  
```{r}
unique(data$Sampling.Unit.Name)
```
**For our data, we would check the number of camera stations by examining the number of unique values in "Camera"**

Then they look at their start and end dates
```{r}
unique(data$Camera.Start.Date.and.Time)
```
**We would not be able to do this step without merging some temporal data into our file.**

##Deriving sampling effort, events, and species list
###Survey effort
Next up in Chapter 5, the authors use temporal data in the data frame to derive the survey effort (measured in camera days where 1 camera out for 1 day = 1 camera day).  They do this with their own function called `cam.days`.  **We will need to add temporal data and possibly write our own code for this step, but it is clearly a step we need to take.**

The required arguments for the `cam.days` function are the dataframe and the sampling period (or sampling year in their case).

```{r}
camera_days<-cam.days(data, 2009.01)
```
**The end product, which we should construct for our own data, is a data frame that lists each camera, the day the camera started operating, ended operating, and then the number of days that the camera was operational.**

They write this dataframe to a table for use elsewhere and then capture some descriptive data, in particular min, max, median and quartiles of sampling effort:
```{r}
summary(camera_days)
```
###Derive events
The next step in chapter 5 is for the authors to derive what they call "...the trapping events according to a user-defined time interval criterion" for each species and each camera trap station.

Doing so requires reshaping the data to obtain camera stations in rows and species observed in columns, where the values in the data frame represent the number of events separated by a specific time threshold.

They run this as events per hour and then again as events per day and use their own function, `event.sp`

```{r}
events_hh<-event.sp(dtaframe = data, year = 2009.01, thresh = 60)
events_dd<-event.sp(dtaframe = data, year = 2009.01, thresh = 1440)
```
We can produce a summary table of events by species:
```{r}
events_hh_species<-colSums(events_hh)

```
The authors then use this data to create a table with species as rows and events_hh, events_dd as the next 2 columns, followed by survey effort column (camera days), the relative abundance index (RAI) per hour and per day (calculated as events_hh/survey effort and events_dd/survey effort, respectively).  They do not give any code for how they construct this table, however. Let's see if we can reproduce it....

First, the events_hh_species gives the column we need for # events per species, comparable to the first column in their new table.  Now let's create that for events_dd

```{r}
events_dd_species<-colSums(events_dd)
```
So now we need to calculate the total survey effort across cameras.  

We'll sum the total number of camera days in the camera_days dataframe:
```{r}
survey_effort<-sum(camera_days$ndays)
```
The result is the 1818 we need for the table. Now we need to make a column of 1818 values for each species.
```{r}
#determine total number of species
numSpecies<-length(events_dd_species)
#create the column of survey effort
samp_effort<-rep(survey_effort, numSpecies)
```

Now let's patch the 3 variables we have so far into a new data frame and then calculate RAI_hh and RAI_dd:
```{r}
Species<-names(events_dd_species)#events_dd_species is a named vector

Fig_5_6<-data.frame(Species) #begins dataframe
Fig_5_6$events_hh_species<-events_hh_species #adds hh data
Fig_5_6$events_dd_species<-events_dd_species #adds dd data
Fig_5_6$Survey_effort<-samp_effort #add survey effort column
```
Now calculate the two RAI's
```{r}
Fig_5_6$RAI_hh<-(Fig_5_6$events_hh_species/Fig_5_6$Survey_effort)*100 #abundance index over 100 hours

Fig_5_6$RAI_dd<-(Fig_5_6$events_dd_species/Fig_5_6$Survey_effort)*100 #abundance index over 100 days
```
There you go!  The resulting `Fig_5_6` data frame is the table that is shown as figure 5.6 in Chapter 5.

###Species Accumulation Curve
Next the authors create a species accumulation curve to show the #of species detected as a function of trapping effort (camera days).  To do so, they use their `acc.curve` function. It takes the "data" dataframe,the year of data for analysis, and drops everything but mammals (which I thought already happened).  I suspect that the data frame they may actually be using is the *team* dataset, but we'll see.  The `acc.curve` function reshapes the data to make it ready for the vegan `specaccum` function so we'll need to pay close attention to how the data are reshaped (vegan usually requires columns of species names and rows of sites or cameras or whatever...)

```{r}
accumulation<-acc.curve(data, 2009.01)
```

This appears to have worked; the result is a dataframe with three columns: camera.trap.days (a sequence from 1 to the total number of camera trap days), species (the #species detected), and the sd estimate around #species.

Let's look a little more closely at the resulting data frame:
```{r}
tail(accumulation, 10)
```
We see a total of 1876 camera trap days.  **I need to figure out how the total number of camera trap days is determined, and, since multiple cameras are out for each single day, why the camera trap days variable is continuous 1:1876 rather than e.g. (if you had 10 cameras out) 10, 20, 30...an increment of 10 for each single date.**

Finally, we create the species accumulation curve:
```{r}
ggplot(accumulation, aes(x = Camera.trap.days, y = species))+
	geom_line(aes(y = species - sd), 
			color = "grey50",
			linetype = "dotted")+
	geom_line(aes(y = species +sd), 
			color = "grey50", 
			linetype = "dotted")+
	geom_line()
	
```
This produces figure 5.8 in the text.

###Activity pattern
The next section of the chapter is on examining activity patterns and making radial plots of activity.  I would ultimately like to do this, but need to work our own data through to the accumulation curve first.

